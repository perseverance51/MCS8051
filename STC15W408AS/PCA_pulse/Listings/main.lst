C51 COMPILER V9.60.0.0   MAIN                                                              05/11/2022 09:37:49 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          //ÓÃCCP/PCAµÄ16Î»²¶»ñÄ£Ê½²âÂö³å¿í¶ÈµÄ³ÌÐò
   2          //µ¥Æ¬»úÐÍºÅ£ºSTC15W408AS
   3          //¹¤×÷ÆµÂÊÒ»°ãÎª11.0592MHz
   4          
   5          #include "reg51.h"
   6          #include "intrins.h"
   7          #include <stdio.h>         // ÎªÊ¹ÓÃKEIL×Ô´øµÄ¿âº¯Êýprintf¶ø¼ÓÈë
   8          #define FOSC    11059200L
   9          
  10          typedef unsigned char BYTE;
  11          typedef unsigned int WORD;
  12          typedef unsigned long DWORD;
  13          BYTE cnt;                           //´æ´¢PCA¼ÆÊ±Òç³ö´ÎÊý
  14          DWORD count0;                       //¼ÇÂ¼ÉÏÒ»´ÎµÄ²¶»ñÖµ
  15          DWORD count1;                       //¼ÇÂ¼±¾´ÎµÄ²¶»ñÖµ
  16          DWORD length;                       //´æ´¢ÐÅºÅµÄÊ±¼ä³¤¶È(count1 - count0)
  17          
  18          sfr P0M1 = 0x93;
  19          sfr P0M0 = 0x94;
  20          sfr P1M1 = 0x91;
  21          sfr P1M0 = 0x92;
  22          sfr P2M1 = 0x95;
  23          sfr P2M0 = 0x96;
  24          sfr P3M1 = 0xb1;
  25          sfr P3M0 = 0xb2;
  26          sfr P4M1 = 0xb3;
  27          sfr P4M0 = 0xb4;
  28          sfr P5M1 = 0xC9;
  29          sfr P5M0 = 0xCA;
  30          
  31          sfr P_SW1       = 0xA2;             //ÍâÉè¹¦ÄÜÇÐ»»¼Ä´æÆ÷1
  32          
  33          #define CCP_S0 0x10                 //P_SW1.4
  34          #define CCP_S1 0x20                 //P_SW1.5
  35          
  36          sfr CCON        =   0xD8;           //PCA¿ØÖÆ¼Ä´æÆ÷
  37          sbit CCF0       =   CCON^0;         //PCAÄ£¿é0ÖÐ¶Ï±êÖ¾
  38          sbit CCF1       =   CCON^1;         //PCAÄ£¿é1ÖÐ¶Ï±êÖ¾
  39          sbit CR         =   CCON^6;         //PCA¶¨Ê±Æ÷ÔËÐÐ¿ØÖÆÎ»
  40          sbit CF         =   CCON^7;         //PCA¶¨Ê±Æ÷Òç³ö±êÖ¾
  41          sfr CMOD        =   0xD9;           //PCAÄ£Ê½¼Ä´æÆ÷
  42          sfr CL          =   0xE9;           //PCA¶¨Ê±Æ÷µÍ×Ö½Ú
  43          sfr CH          =   0xF9;           //PCA¶¨Ê±Æ÷¸ß×Ö½Ú
  44          sfr CCAPM0      =   0xDA;           //PCAÄ£¿é0Ä£Ê½¼Ä´æÆ÷
  45          sfr CCAP0L      =   0xEA;           //PCAÄ£¿é0²¶»ñ¼Ä´æÆ÷ LOW
  46          sfr CCAP0H      =   0xFA;           //PCAÄ£¿é0²¶»ñ¼Ä´æÆ÷ HIGH
  47          sfr CCAPM1      =   0xDB;           //PCAÄ£¿é1Ä£Ê½¼Ä´æÆ÷
  48          sfr CCAP1L      =   0xEB;           //PCAÄ£¿é1²¶»ñ¼Ä´æÆ÷ LOW
  49          sfr CCAP1H      =   0xFB;           //PCAÄ£¿é1²¶»ñ¼Ä´æÆ÷ HIGH
  50          sfr CCAPM2      =   0xDC;           //PCAÄ£¿é2Ä£Ê½¼Ä´æÆ÷
  51          sfr CCAP2L      =   0xEC;           //PCAÄ£¿é2²¶»ñ¼Ä´æÆ÷ LOW
  52          sfr CCAP2H      =   0xFC;           //PCAÄ£¿é2²¶»ñ¼Ä´æÆ÷ HIGH
  53          sfr PCA_PWM0    =   0xf2;           //PCAÄ£¿é0µÄPWM¼Ä´æÆ÷
  54          sfr PCA_PWM1    =   0xf3;           //PCAÄ£¿é1µÄPWM¼Ä´æÆ÷
C51 COMPILER V9.60.0.0   MAIN                                                              05/11/2022 09:37:49 PAGE 2   

  55          sfr PCA_PWM2    =   0xf4;           //PCAÄ£¿é2µÄPWM¼Ä´æÆ÷
  56          
  57          sfr AUXR        =   0x8E;   //0000,0000 ¸¨Öú¼Ä´æÆ÷
  58          sfr T2H         =   0xD6;   //0000,0000 T2¸ß×Ö½Ú
  59          sfr T2L         =   0xD7;   //0000,0000 T2µÍ×Ö½Ú
  60          sbit EPCA       =   IE^6;           //PCAÖÐ¶ÏÔÊÐíÎ»
  61          
  62          /*------------------------------------------------
  63                           ´®¿Ú³õÊ¼»¯º¯Êý£¬²¨ÌØÂÊ9600
  64          ------------------------------------------------*/
  65           void UART_init(void)
  66          {
  67   1          SCON = 0x50;    //8Î»Êý¾Ý,¿É±ä²¨ÌØÂÊ
  68   1        AUXR |= 0x01;   //´®¿Ú1Ñ¡Ôñ¶¨Ê±Æ÷2Îª²¨ÌØÂÊ·¢ÉúÆ÷
  69   1        AUXR &= 0xFB;   //¶¨Ê±Æ÷Ê±ÖÓ12TÄ£Ê½
  70   1        T2L = 0xE8;   //ÉèÖÃ¶¨Ê±³õÊ¼Öµ
  71   1        T2H = 0xFF;   //ÉèÖÃ¶¨Ê±³õÊ¼Öµ
  72   1        AUXR |= 0x10;   //¶¨Ê±Æ÷2¿ªÊ¼¼ÆÊ±
  73   1        TI=1;     // ºÜ¹Ø¼ü£¬Ê¹ÓÃprintfº¯ÊýÊ±±ØÐëÓÐ´ËÃüÁî
  74   1        ES = 1; //¿ªÆô´®¿ÚÖÐ¶Ï
  75   1        EA=1;        //¿ªÆô×ÜÖÐ¶Ï
  76   1      }
  77          //UART1 ·¢ËÍ´®¿ÚÊý¾Ý
  78          void UART1_SendData(char dat)
  79          {
  80   1          ES=0;           //¹Ø´®¿ÚÖÐ¶Ï
  81   1          SBUF=dat;           
  82   1          while(TI!=1);   //µÈ´ý·¢ËÍ³É¹¦
  83   1          TI=0;           //Çå³ý·¢ËÍÖÐ¶Ï±êÖ¾
  84   1          ES=1;           //¿ª´®¿ÚÖÐ¶Ï
  85   1      }
  86           
  87          //UART1 ·¢ËÍ×Ö·û´®reentrant
  88          //void UART1_SendString(char *s)
  89          //{
  90          //    while(*s)//¼ì²â×Ö·û´®½áÊø·û
  91          //    {
  92          //        UART1_SendData(*s++);//·¢ËÍµ±Ç°×Ö·û
  93          //    }
  94          //}
  95           
  96          //ÖØÐ´putcharº¯Êý
  97          char putchar(char c) 
  98          {
  99   1          UART1_SendData(c);
 100   1          return c;
 101   1      }
 102          
 103          void Delay500ms()   //@11.0592MHz
 104          {
 105   1        unsigned char i, j, k;
 106   1      
 107   1        _nop_();
 108   1        _nop_();
 109   1        i = 22;
 110   1        j = 3;
 111   1        k = 227;
 112   1        do
 113   1        {
 114   2          do
 115   2          {
 116   3            while (--k);
C51 COMPILER V9.60.0.0   MAIN                                                              05/11/2022 09:37:49 PAGE 3   

 117   3          } while (--j);
 118   2        } while (--i);
 119   1      }
 120          
 121          void main()
 122          {
 123   1          P0M1 = 0x03; 
 124   1          P0M0 = 0x00; //P0(Ë«Ë«Ë«Ë«Ë«Ë«¸ß¸ß)
 125   1      //    P1M0 = 0x00;
 126   1      //    P1M1 = 0x00;
 127   1          P2M0 = 0x00;
 128   1          P2M1 = 0x00;
 129   1          P3M0 = 0x00;
 130   1          P3M1 = 0x00;
 131   1          P4M0 = 0x00;
 132   1          P4M1 = 0x00;
 133   1          P5M0 = 0x00;
 134   1          P5M1 = 0x00;
 135   1          ACC = P_SW1;
 136   1          ACC &= ~(CCP_S0 | CCP_S1);      //CCP_S0=0 CCP_S1=0
 137   1          P_SW1 = ACC;                    //(P1.2/ECI, P1.1/CCP0, P1.0/CCP1, P3.7/CCP2)
 138   1          
 139   1      //  ACC = P_SW1;
 140   1      //  ACC &= ~(CCP_S0 | CCP_S1);      //CCP_S0=1 CCP_S1=0
 141   1      //  ACC |= CCP_S0;                  //(P3.4/ECI_2, P3.5/CCP0_2, P3.6/CCP1_2, P3.7/CCP2_2)
 142   1      //  P_SW1 = ACC;  
 143   1      //  
 144   1      //  ACC = P_SW1;
 145   1      //  ACC &= ~(CCP_S0 | CCP_S1);      //CCP_S0=0 CCP_S1=1
 146   1      //  ACC |= CCP_S1;                  //(P2.4/ECI_3, P2.5/CCP0_3, P2.6/CCP1_3, P2.7/CCP2_3)
 147   1      //  P_SW1 = ACC;  
 148   1      
 149   1          CCON = 0;                       //³õÊ¼»¯PCA¿ØÖÆ¼Ä´æÆ÷
 150   1                                          //PCA¶¨Ê±Æ÷Í£Ö¹
 151   1                                          //Çå³ýCF±êÖ¾
 152   1                                          //Çå³ýÄ£¿éÖÐ¶Ï±êÖ¾
 153   1          CL = 0;                         //¸´Î»PCA¼Ä´æÆ÷
 154   1          CH = 0;
 155   1          CCAP0L = 0;
 156   1          CCAP0H = 0;
 157   1      //    CMOD = 0x09;                    //ÉèÖÃPCAÊ±ÖÓÔ´ÎªÏµÍ³Ê±ÖÓSYSclk/4,ÇÒÊ¹ÄÜPCA¼ÆÊ±Òç³öÖÐ¶Ï
 158   1          CMOD = 0x01;    //SYSclk/12
 159   1          CCAPM0 = 0x21;                  //PCAÄ£¿é0Îª16Î»²¶»ñÄ£Ê½(ÉÏÉýÑØ²¶»ñ,¿É²â´Ó¸ßµçÆ½¿ªÊ¼µÄÕû¸öÖÜÆÚ),ÇÒ²úÉú
             -²¶»ñÖÐ¶Ï
 160   1      //  CCAPM0 = 0x11;                  //PCAÄ£¿é0Îª16Î»²¶»ñÄ£Ê½(ÏÂ½µÑØ²¶»ñ,¿É²â´ÓµÍµçÆ½¿ªÊ¼µÄÕû¸öÖÜÆÚ),ÇÒ²úÉú
             -²¶»ñÖÐ¶Ï
 161   1       // CCAPM0 = 0x31;                  //PCAÄ£¿é0Îª16Î»²¶»ñÄ£Ê½(ÉÏÉýÑØ/ÏÂ½µÑØ²¶»ñ,¿É²â¸ßµçÆ½»òÕßµÍµçÆ½¿í¶È),Ç
             -Ò²úÉú²¶»ñÖÐ¶Ï
 162   1      
 163   1          CR = 1;                         //PCA¶¨Ê±Æ÷¿ªÊ¼¹¤×÷
 164   1          EA = 1;
 165   1      
 166   1          cnt = 0;
 167   1          count0 = 0;
 168   1          count1 = 0;
 169   1          UART_init();
 170   1      //  printf("STC15W408AS \n");
 171   1      //  printf("TRG!!!\n");
 172   1          while (1){
 173   2      //      if(length > 0){
 174   2      //        CCAPM0 = 0x00; //¹Ø±Õ±È½Ï¹¦ÄÜ
 175   2      //      printf("Pulse_length: %lu\n",length);
C51 COMPILER V9.60.0.0   MAIN                                                              05/11/2022 09:37:49 PAGE 4   

 176   2      //      length = 0 ;
 177   2      //      Delay500ms();
 178   2      //      CCAPM0 = 0x21; //¿ªÆô±È½Ï¹¦ÄÜ
 179   2      //      }
 180   2          }
 181   1      }
 182          
 183          void PCA_isr() interrupt 7
 184          { 
 185   1       if (CF)
 186   1       {
 187   2       CF = 0;
 188   2       cnt++; //PCA¼ÆÊ±Òç³ö´ÎÊý+1
 189   2       }
 190   1       if (CCF0)
 191   1       {
 192   2       CCF0 = 0;
 193   2       count0 = count1; //±¸·ÝÉÏÒ»´ÎµÄ²¶»ñÖµ
 194   2       ((BYTE *)&count1)[3] = CCAP0L; //±£´æ±¾´ÎµÄ²¶»ñÖµ
 195   2       ((BYTE *)&count1)[2] = CCAP0H;
 196   2       ((BYTE *)&count1)[1] = cnt;
 197   2       ((BYTE *)&count1)[0] = 0;
 198   2       length = count1 - count0; //¼ÆËãÁ½´Î²¶»ñµÄ²îÖµ,¼´µÃµ½Ê±¼ä³¤¶È
 199   2        printf("Pulse_length: %lu\n",length);
 200   2       }
 201   1      
 202   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    266    ----
   CONSTANT SIZE    =     19    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
