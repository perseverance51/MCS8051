C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE ST7920
OBJECT MODULE PLACED IN .\Objects\st7920.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE SRC\st7920.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listing
                    -s\st7920.lst) TABS(2) OBJECT(.\Objects\st7920.obj)

line level    source

   1          //ST7920 LCD é©±åŠ¨
   2          #include "st7920.h"
*** ERROR C141 IN LINE 67 OF SRC\st7920.h: syntax error near ')', expected '<id>'
*** ERROR C141 IN LINE 70 OF SRC\st7920.h: syntax error near ')', expected '<id>'
*** ERROR C141 IN LINE 71 OF SRC\st7920.h: syntax error near ')', expected '<id>'
*** ERROR C141 IN LINE 81 OF SRC\st7920.h: syntax error near ')', expected '<id>'
   3          
   4          //åˆå§‹åŒ–
   5          void LCD_init(void)
   6          {
   7   1          LCD_DATA_DDR_OUTPUT();
*** ERROR C202 IN LINE 7 OF SRC\st7920.c: 'DDRB': undefined identifier
   8   1      
   9   1          _delay_ms(50);
  10   1          LCD_write_command(0x33);
  11   1          _delay_ms(1);
  12   1          LCD_write_command(0x32);
  13   1          _delay_ms(1);
  14   1      #if LCD_INTERFACE == MODE_4BIT
                  LCD_write_command(0x28);
                  _delay_ms(1);
                  LCD_write_command(0x28);
                  _delay_ms(1);
              #endif
  20   1          LCD_write_command(0x08);  //æ˜¾ç¤ºå…³
  21   1          _delay_ms(1);             //å¤§äº100uSçš„å»¶æ—¶ç¨‹åº
  22   1          LCD_write_command(0x10);  //å…‰æ ‡è®¾ç½®
  23   1          _delay_ms(1);             //å¤§äº100uSçš„å»¶æ—¶ç¨‹åº
  24   1          LCD_write_command(0x0C);  //æ˜¾ç¤ºå¼€
  25   1          _delay_ms(1);             //å¤§äº100uSçš„å»¶æ—¶ç¨‹åº
  26   1          LCD_write_command(0x01);  //Display Clear
  27   1          _delay_ms(10);            //å¤§äº10mSçš„å»¶æ—¶ç¨‹åº
  28   1          LCD_write_command(0x06);  //å…‰æ ‡ä»å³å‘å·¦åŠ 1ä½ç§»åŠ¨
  29   1          _delay_ms(10);            //å¤§äº10mSçš„å»¶æ—¶ç¨‹åº
  30   1      }
  31          
  32          //å†™å‘½ä»¤
  33          void LCD_write_command(unsigned char command)
  34          {
  35   1      #if LCD_INTERFACE == MODE_SERIAL
  36   1          CLR_BIT(LCD_SCLK_PORT, LCD_SCLK_PIN);
  37   1          LCD2_spi_write_byte(0xf8);
  38   1          asm("nop");
  39   1          LCD2_spi_write_byte_standard(command);
  40   1      #else
                  LCD_CMD_MODE();   //RS=0
                  LCD_write_byte(command);
                  _delay_ms(1);
              #endif
  45   1      }
  46          
  47          //å†™æ•°æ®
  48          void LCD_write_data(unsigned char data)
  49          {
C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 2   

  50   1      #if LCD_INTERFACE == MODE_SERIAL
  51   1          CLR_BIT(LCD_SCLK_PORT, LCD_SCLK_PIN);
  52   1          LCD2_spi_write_byte(0xfa);
  53   1          asm("nop");
  54   1          LCD2_spi_write_byte_standard(data);
  55   1      #else
                  LCD_DATA_MODE();    //RS=1
                  LCD_write_byte(data);
              #endif
  59   1      }
  60          
  61          //å¹¶å£æ¨¡å¼å†™ä¸€ä¸ªå­—èŠ‚åˆ°æ§åˆ¶å™¨
  62          void LCD_write_byte(unsigned char data)
  63          {
*** ERROR C236 IN LINE 63 OF SRC\st7920.c: '_LCD_write_byte': different length of parameter lists
  64   1      #if LCD_INTERFACE == MODE_4BIT
                  LCD_write_half_byte(data);
                  data <<= 4;
                  LCD_write_half_byte(data);
              #else
  69   1          LCD_DATA_PORT = data;
*** ERROR C202 IN LINE 69 OF SRC\st7920.c: 'PORTB': undefined identifier
*** ERROR C141 IN LINE 69 OF SRC\st7920.c: syntax error near 'data', expected 'sizeof'
  70   1          LCD_RW_LOW();
  71   1          LCD_EN_HIGH();     //ENç«¯äº§ç”Ÿä¸€ä¸ªç”±ä½ç”µå¹³å˜é«˜ç”µå¹³ï¼Œå†™LCD
*** ERROR C202 IN LINE 71 OF SRC\st7920.c: 'PORTD': undefined identifier
  72   1          _delay_us(10);
  73   1          LCD_EN_LOW();      //ENç«¯äº§ç”Ÿä¸€ä¸ªç”±é«˜ç”µå¹³å˜ä½ç”µå¹³ï¼Œå†™LCD
  74   1          _delay_us(10);
  75   1          LCD_RW_HIGH();
  76   1      #endif
  77   1      }
  78          
  79          //4ä½æ¨¡å¼ä¸‹å†™åŠä¸ªå­—èŠ‚ï¼ˆé«˜4ä½ï¼‰
  80          void LCD_write_half_byte(unsigned char half_byte)
  81          {
  82   1          if (half_byte & 0x80)
  83   1              SET_BIT(LCD_DATA_PORT_D7, LCD_DATA_PIN_D7);
  84   1          else
  85   1              CLR_BIT(LCD_DATA_PORT_D7, LCD_DATA_PIN_D7);
  86   1          
  87   1          if (half_byte & 0x40)
  88   1              SET_BIT(LCD_DATA_PORT_D6, LCD_DATA_PIN_D6);
  89   1          else
  90   1              CLR_BIT(LCD_DATA_PORT_D6, LCD_DATA_PIN_D6);
  91   1          
  92   1          if (half_byte & 0x20)
  93   1              SET_BIT(LCD_DATA_PORT_D5, LCD_DATA_PIN_D5);
  94   1          else
  95   1              CLR_BIT(LCD_DATA_PORT_D5, LCD_DATA_PIN_D5);
  96   1          
  97   1          if (half_byte & 0x10)
  98   1              SET_BIT(LCD_DATA_PORT_D4, LCD_DATA_PIN_D4);
  99   1          else
 100   1              CLR_BIT(LCD_DATA_PORT_D4, LCD_DATA_PIN_D4);
 101   1          
 102   1          LCD_RW_LOW();
 103   1          LCD_EN_HIGH();         //ENç«¯äº§ç”Ÿä¸€ä¸ªç”±ä½ç”µå¹³å˜é«˜ç”µå¹³ï¼Œå†™LCD
 104   1          _delay_us(10);
 105   1          LCD_EN_LOW();          //ENç«¯äº§ç”Ÿä¸€ä¸ªç”±é«˜ç”µå¹³å˜ä½ç”µå¹³ï¼Œå†™LCD
 106   1          _delay_us(10); 
 107   1          LCD_RW_HIGH();
C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 3   

 108   1      }
 109          
 110          //ä¸²è¡Œæ¨¡å¼ä¸‹å†™ä¸€ä¸ªå­—èŠ‚
 111          void LCD2_spi_write_byte(unsigned char data)
 112          {
 113   1          unsigned char i;
 114   1          for(i=0; i<8; i++)
 115   1          {
 116   2              if (data & 0x80)
 117   2                  SET_BIT(LCD_SID_PORT, LCD_SID_PIN);
 118   2              else
 119   2                  CLR_BIT(LCD_SID_PORT, LCD_SID_PIN);
 120   2      
 121   2              asm("nop");
 122   2              asm("nop");
 123   2              CLR_BIT(LCD_SCLK_PORT, LCD_SCLK_PIN);
 124   2              asm("nop");
 125   2              SET_BIT(LCD_SCLK_PORT, LCD_SCLK_PIN);
 126   2              data <<= 1;
 127   2          }
 128   1      }
 129          
 130          //æ ‡å‡†å¤„ç†ï¼Œä¸€ä¸ªå­—èŠ‚è¦æ‹†æˆä¸¤ä¸ªå­—èŠ‚å‘é€
 131          void LCD2_spi_write_byte_standard(unsigned char data)
 132          {
 133   1          LCD2_spi_write_byte(data & 0xf0);
 134   1          LCD2_spi_write_byte((data << 4) & 0xf0);
 135   1      }
 136          
 137          //å¹¶å£æ¨¡å¼ä¸‹è¯»æ•°æ®
 138          unsigned char LCD_read_data(void)
 139          {
 140   1          unsigned char data;
 141   1      
 142   1          LCD_DATA_MODE();
 143   1          data = LCD_read_byte();
 144   1      
 145   1      #if LCD_INTERFACE == MODE_4BIT
                  data = (data & 0xf0) | ((LCD_read_byte() >> 4) & 0x0f);
              #endif
 148   1          return data;
 149   1      }
 150          
 151          //å¹¶å£æ¨¡å¼ä¸‹è¯»çŠ¶æ€
 152          unsigned char LCD_read_status(void)
 153          {
 154   1          unsigned char data;
 155   1          LCD_CMD_MODE();
 156   1          data = LCD_read_byte();
 157   1      #if LCD_INTERFACE == MODE_4BIT
                  data = (data & 0xf0) | ((LCD_read_byte() >> 4) & 0x0f);
              #endif
 160   1          return data;
 161   1      }
 162          
 163          //å¹¶å£æ¨¡å¼ä¸‹è¯»ä¸€ä¸ªå­—èŠ‚ï¼Œå¦‚æœæ˜¯4bitæ¨¡å¼ï¼Œåˆ™åªæœ‰é«˜4ä½æ˜¯æœ‰æ•ˆçš„
 164          unsigned char LCD_read_byte(void)
 165          {
 166   1          unsigned char data;
 167   1          LCD_DATA_DDR_INPUT();
 168   1          LCD_RW_HIGH();
 169   1          
C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 4   

 170   1          LCD_EN_LOW();         //ENç«¯äº§ç”Ÿä¸Šå‡æ²¿ï¼ŒST7920å¼€å§‹è¾“å‡ºæ•°æ®
 171   1          _delay_us(10);
 172   1          LCD_EN_HIGH();
 173   1          _delay_us(10);
 174   1      
 175   1          data = LCD_DATA_PIN;
 176   1          LCD_EN_LOW();
 177   1          LCD_DATA_DDR_OUTPUT();
 178   1          return data;
 179   1      }
 180          
 181          //è®¾ç½®å­—ç¬¦æ¨¡å¼çš„åœ°å€
 182          //ç¬¬ä¸€è¡Œé¦–åœ°å€ï¼š0x80
 183          //ç¬¬äºŒè¡Œé¦–åœ°å€ï¼š0x80+0x10 (0x90)
 184          //ç¬¬ä¸‰è¡Œé¦–åœ°å€ï¼š0x80+0x08 (0x88)
 185          //ç¬¬å››è¡Œé¦–åœ°å€ï¼š0x80+0x10+0x08 (0x98)
 186          void LCD_set_text_address(unsigned int rowCol)
 187          {
 188   1          unsigned char start = 0x80;
 189   1          unsigned char row = (rowCol >> 8) & 0xff;
 190   1          unsigned char col = rowCol & 0xff;
 191   1      
 192   1          if (row == 1) {
 193   2              start = 0x90;
 194   2          }
 195   1          if (row == 2) {
 196   2              start = 0x88;
 197   2          }
 198   1          if (row == 3) {
 199   2              start = 0x98;
 200   2          }
 201   1          LCD_write_command(start + col);
 202   1      }
 203          
 204          //å°†å­—ç¬¦æ¨¡å¼çš„è¡Œåˆ—å·è½¬æ¢ä¸ºå†…éƒ¨çš„XYåæ ‡ï¼Œè¿”å›çš„é«˜å­—èŠ‚ä¸ºXï¼Œä½å­—èŠ‚ä¸ºY
 205          //row (HIGH_BYTE(rowCol)): è¡Œå·ï¼Œ0-3
 206          //col (LOW_BYTE(rowCol)): åˆ—å·ï¼Œ0-7
 207          unsigned int LCD_rowCol_to_inter_Xy(unsigned int rowCol)
 208          {
 209   1          unsigned char row = (rowCol >> 8) & 0x03;
 210   1          unsigned char col = rowCol & 0x07;
 211   1          unsigned char x = col + 8 * (unsigned char)(row / 2);
 212   1          unsigned char y = (row * 16) & 0x1f;
 213   1          return (x << 8) | y;
 214   1      }
 215          
 216          //è®¾ç½®ç»˜å›¾æ¨¡å¼çš„åœ°å€
 217          //x: 0-127 (æ³¨æ„xå¿…é¡»ä¸º16çš„æ•´æ•°å€)
 218          //y:0-63
 219          void LCD_set_graphic_address(unsigned char x, unsigned char y)
 220          {
 221   1          unsigned char xWord, downPage, yInter;
 222   1      
 223   1          x &= 0x7f;
 224   1          y &= 0x3f;
 225   1          xWord = x / 16;           //å†…éƒ¨Xåœ°å€ï¼Œä¸€ä¸ªåœ°å€ç®¡16ä½
 226   1          downPage = y / 32;        //0:ä¸ŠåŠå± 1:ä¸‹åŠå±
 227   1          yInter = y & 0x1f;        //å†…éƒ¨Yåæ ‡
 228   1          
 229   1          LCD_write_command(0x80 + yInter); //å…ˆè®¾ç½®Yåœ°å€
 230   1          LCD_write_command(0x80 + xWord + 8 * downPage);
 231   1      }
C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 5   

 232          
 233          //æ˜¾ç¤ºæ¸…å±å‡½æ•°
 234          void LCD_clear(void)
 235          {
 236   1          unsigned char x, y;
 237   1          LCD_write_command(0x08);  //é¿å…æ¸…å±è¿‡ç¨‹ä¸­é—ªçƒï¼Œå…ˆå…³æ˜¾ç¤º
 238   1          _delay_us(100);
 239   1          LCD_write_command(0x01);  //æ¸…DDRAM
 240   1      
 241   1          //æ¸…GDRAM,12864ä»…ç”¨äº†ä¸€åŠçš„GDRAMï¼Œæ¸…ä¸€åŠå³å¯
 242   1          //å¦‚æœæ²¡æœ‰ä½¿ç”¨åˆ°ç»˜å›¾GDRAMï¼Œä¹Ÿå¯ä»¥ä¸æ¸…GDRAMï¼Œçœç‚¹æ—¶é—´å’Œä»£ç ç©ºé—´
 243   1          LCD_startGraphic();
 244   1          for (y = 0; y < 32; y++)
 245   1          {
 246   2              LCD_write_command(0x80 + y); //y
 247   2              LCD_write_command(0x80 + 0); //x
 248   2              for (x = 0; x < 16; x++)
 249   2              {
 250   3                  LCD_write_data(0x00);
 251   3                  LCD_write_data(0x00);
 252   3              }
 253   2          }
 254   1          LCD_endGraphic();
 255   1      
 256   1          LCD_write_command(0x0C);  //æ˜¾ç¤ºå¼€
 257   1          _delay_ms(10);
 258   1      }
 259          
 260          //å¼€å¯æ‰©å±•å‘½ä»¤çš„ç»˜å›¾æŒ‡ä»¤
 261          void LCD_startGraphic(void)
 262          {
 263   1      #if LCD_INTERFACE == MODE_4BIT
                  LCD_write_command(0x24);          //æ‰©å±•æŒ‡ä»¤é›†
                  LCD_write_command(0x26);          //ç»˜å›¾å‘½ä»¤å¼€å¯
              #else
 267   1          LCD_write_command(0x34);          //æ‰©å±•æŒ‡ä»¤é›†
 268   1          LCD_write_command(0x36);          //ç»˜å›¾å‘½ä»¤å¼€å¯
 269   1      #endif
 270   1      }
 271          
 272          //ç»“æŸæ‰©å±•å‘½ä»¤çš„ç»˜å›¾æŒ‡ä»¤(å¯é€‰)
 273          void LCD_endGraphic(void)
 274          {
 275   1      #if LCD_INTERFACE == MODE_4BIT
                  LCD_write_command(0x26); //ç»˜å›¾å‘½ä»¤å…³é—­
                  LCD_write_command(0x20); //å›åˆ°åŸºæœ¬æŒ‡ä»¤
              #else
 279   1          LCD_write_command(0x36); //ç»˜å›¾å‘½ä»¤å…³é—­
 280   1          LCD_write_command(0x30); //å›åˆ°åŸºæœ¬æŒ‡ä»¤
 281   1      #endif
 282   1      }
 283          
 284          //åç™½æˆ–å–æ¶ˆåç™½å¯¹åº”16X16åŒºåŸŸï¼Œä¸€èˆ¬ç”¨äºèœå•é€‰æ‹©
 285          //row (HIGH_BYTE(rowCol)): è¡Œå·ï¼Œ0-3
 286          //col (LOW_BYTE(rowCol)): åˆ—å·ï¼Œ0-7
 287          //charNum: è¦åç™½çš„å­—ç¬¦æ•°é‡ï¼Œæ³¨æ„ä¸è¦è¶…è¿‡è¡Œæœ«
 288          //ST7920å†…ç½®çš„åç™½ä½œç”¨ä¸å¤§ï¼Œå®ƒåªèƒ½æ•´è¡Œåç™½ï¼Œè€Œä¸”åç™½ç¬¬ä¸€è¡Œï¼Œç¬¬ä¸‰è¡Œä¹Ÿä¼šä¸€èµ
             -·åç™½
 289          //æ‰€ä»¥æ­¤å‡½æ•°ä½¿ç”¨å¦å¤–çš„æ–¹æ³•å®ç°ï¼šç»˜å›¾åŒºå¯¹åº”çš„ä½å…¨éƒ¨å†™0xffï¼Œå¼‚æˆ–åå³å¯åç™½
 290          void LCD_Inverse_16X16(unsigned int rowCol, unsigned char charNum, unsigned char reverse)
 291          {
 292   1          unsigned char i, ch;
C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 6   

 293   1          unsigned int xy = LCD_rowCol_to_inter_Xy(rowCol);
 294   1          unsigned char x = (xy >> 8) & 0xff;
 295   1          unsigned char y = xy & 0x3f;
 296   1      
 297   1          LCD_startGraphic();
 298   1          for (i = 0; i < 16; i++) //æŠŠå¯¹åº”å­—ç¬¦çš„GDRAMå…¨éƒ¨å†™æˆ0xffï¼Œå¼‚æˆ–åå°±æ˜¯åç™½
 299   1          {
 300   2              LCD_write_command(0x80 + y + i);   //å…ˆå†™å‚ç›´åœ°å€y
 301   2              LCD_write_command(0x80 + x);       //x
 302   2              for (ch = 0; ch < charNum; ch++)
 303   2              {
 304   3                  LCD_write_data(reverse ? 0xff : 0x00);
 305   3                  LCD_write_data(reverse ? 0xff : 0x00);
 306   3              }
 307   2          }
 308   1          LCD_endGraphic();
 309   1      }
 310          
 311          //æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ï¼Œ12864å¯ä»¥æ˜¾ç¤º4è¡Œï¼Œæ¯è¡Œ8ä¸ªæ±‰å­—æˆ–æ¯è¡Œ16ä¸ªå­—æ¯
 312          //col: åˆ—å·ï¼Œ0-15
 313          //row: è¡Œå·ï¼Œ0-3
 314          //å­—ç¬¦ç¼–ç ï¼šå°äº0x80çš„ä¸ºASCIIï¼Œå¦åˆ™ä¸ºæ±‰å­—ï¼Œæ±‰å­—ç¼–ç é«˜å­—èŠ‚åœ¨å·¦è¾¹
 315          void LCD_write_char(unsigned int rowCol, unsigned int code)
 316          {
 317   1          unsigned char high = (code >> 8) & 0xff;
 318   1          unsigned char low = code & 0xff;
 319   1          LCD_set_text_address(rowCol);
 320   1          if (code > 0x80)
 321   1          {
 322   2              LCD_write_data(high);
 323   2          }
 324   1          LCD_write_data(low);
 325   1      }
 326          
 327          //æ˜¾ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ³¨æ„ä¸è¦è¶…è¿‡ä¸€è¡Œçš„é•¿åº¦ï¼ˆ8ä¸ªæ±‰å­—æˆ–16ä¸ªå­—æ¯ï¼‰
 328          //rowCol: å·¦8ä½ä¸ºè¡Œ(0-3)ï¼Œå³8ä½ä¸ºåˆ—(0-15)
 329          void LCD_write_string(unsigned int rowCol, const char * p)
 330          {
 331   1          LCD_set_text_address(rowCol);
 332   1          while (*p != 0)
 333   1          {
 334   2              LCD_write_data(*p);
 335   2              p++;
 336   2          }
 337   1      }
 338          
 339          //åªæœ‰å¹¶è¡Œæ¥å£èƒ½è¯»ST7920ï¼Œå¦‚æœä¸²è¡Œæ¥å£éœ€è¦æ‰“ç‚¹ï¼Œåˆ™éœ€è¦å¼€è¾ŸRAMç¼“å†²åŒº
 340          #if LCD_INTERFACE != MODE_SERIAL
              //åœ¨å¯¹åº”X/Yä½ç½®æ˜¾ç¤ºä¸€ä¸ªç‚¹
              void LCD_write_dot(unsigned char x, unsigned char y)
              {
                  unsigned char xBit, high, low;
              
                  xBit = x & 0x0f;
                  LCD_startGraphic();
                  LCD_set_graphic_address(x, y);
                  LCD_read_data();    //æ ¹æ®æ‰‹å†Œï¼Œè®¾ç½®å®Œåœ°å€åçš„ç¬¬ä¸€æ¬¡è¯»æ“ä½œè¿”å›çš„æ•°æ®æ— æ•ˆ
              
                  high = LCD_read_data();
                  low = LCD_read_data();
              
                  //å›å†™
C51 COMPILER V9.60.0.0   ST7920                                                            12/22/2021 10:31:52 PAGE 7   

                  LCD_set_graphic_address(x, y);
                  if (xBit < 8)   //ä½8ä½
                  {
                      LCD_write_data(high | (0x01 << (7 - xBit)));
                      LCD_write_data(low);
                  }
                  else
                  {
                      LCD_write_data(high);
                      LCD_write_data(low | (0x01 << (15 - xBit)));
                  }
                  LCD_endGraphic();
              }
              #endif

C51 COMPILATION COMPLETE.  0 WARNING(S),  9 ERROR(S)
